!function(t,a){"object"==typeof exports&&"undefined"!=typeof module?module.exports=a():"function"==typeof define&&define.amd?define(a):(t="undefined"!=typeof globalThis?globalThis:t||self).threddsCrawler=a()}(this,(function(){"use strict";class t{constructor(t,a,e){this.parseUrl=t,this.proxy=a.proxy?a.proxy:null,this.DOMParser=e}async getData(t){t=this.proxy?`${this.proxy}${t}`:t;const a=await fetch(t),e=await a.text();return this.parseStringSync(e)}parseStringSync(t){return function(t,a,e){if(!t)return{};function s(t,a){if(!t)return null;let e="",n=null,i=null;if(t.childNodes&&t.childNodes.length>0)for(var o=0;o<t.childNodes.length;++o){const a=t.childNodes[o],i=a.nodeType,h=r(a.localName||a.nodeName),c=a.text||a.nodeValue||"";if(8!==i)if(3!==i&&4!==i&&h)n=n||{},n[h]?(n[h].length||(n[h]=l(n[h])),n[h]=l(n[h]),n[h][n[h].length]=s(a),n[h].length=n[h].length):n[h]=s(a);else{if(c.match(/^\s+$/))continue;e+=c.replace(/^\s+/,"").replace(/\s+$/,"")}}if(t.attributes&&t.attributes.length>0){i={},n=n||{};for(var h=0;h<t.attributes.length;++h){let a=t.attributes[h],e=r(a.name),s=a.value;i[e]=s,n[e]?(n[cnn]=l(n[cnn]),n[e][n[e].length]=s,n[e].length=n[e].length):n[e]=s}}if(n){var c=""!==e?new String(e):{};for(var d in n)n.hasOwnProperty(d)&&(c[d]=n[d]);n=c,e=n.text?[n.text||""].concat([e]):e,e&&(n.text=e),e=""}return n||e}var r=function(t){return String(t||"").replace(/-/g,"_")},l=function(t){return Array.isArray(t)||(t=[t]),t.length=t.length,t};if("string"==typeof t){t=(new e).parseFromString(t,"text/xml")}if(!t.nodeType)return;if(3===t.nodeType||4===t.nodeType)return t.nodeValue;var n=9===t.nodeType?t.documentElement:t,i=s(n);return t=null,n=null,i}(t,0,this.DOMParser)}}function a(t){return new URL(t)}class e{constructor(t,a){this.parent=a,this.id=t.ID,this.name=t.name,this.urlPath=t.urlPath?t.urlPath:null,this.dataType=t.dataType?t.dataType:null,this.dataFormat=t.dataFormat?t.dataFormat:null,t.dataSize?this.dataSize={size:t.dataSize["#text"],unit:t.dataSize.$units}:this.dataSize=null,t.date?this.date={size:t.date["#text"],type:t.date.$type}:this.date=null,this.metadata=t.metadata?t.metadata:null,this.isParentDataset=null===this.dataSize,this.datasets=[],this._datasetJson=t,this.catalogsAreLoaded=!1,this.catalogs=[]}async getNestedDatasets(){const t=this._datasetJson;if(t.dataset){Array.isArray(t.dataset)||(t.dataset=[t.dataset]);for(let a=0;a<t.dataset.length;a++){const s=new e(t.dataset[a],this);await s.getNestedDatasets(),this.datasets.push(s)}}}async loadAllNestedCatalogs(){const t=this._datasetJson;if(t.catalogRef){Array.isArray(t.catalogRef)||(t.catalogRef=[t.catalogRef]);for(let a=0;a<t.catalogRef.length;a++){const e=this._cleanUrl(t.catalogRef[a]["xlink:href"]);try{const s=new r(e,t.catalogRef[a],this,this.parent._requestor);await s._loadCatalog(),this.catalogs.push(s)}catch(t){console.error(`Couldn't create catalog within dataset:\n                        Dataset URL: ${e}\n                        ${t}`)}}}this.catalogsAreLoaded=!0}_cleanUrl(t){return t.indexOf("://")>=0?t:`${this.parentCatalog._catalogBaseUrl}${t}`}get wmsUrl(){return this.supportsWms?`${this.parentCatalog.wmsBase}${this.urlPath}?service=WMS&version=1.3.0&request=GetCapabilities`:null}get parentCatalog(){const t=this.parent;return t.isParentDataset?t.parent:t}get supportsWms(){return!this.isParentDataset&&this.parentCatalog.supportsWms}}class s{constructor(t){this.name=t.name,this.type=t.serviceType,this.baseUrl=t.base}}class r{constructor(t,a,e,s){this.url=t,this.name=null!==a?a.name:null,this.title=null!==a?a["xlink:title"]:null,this.id=null!==a?a.ID:null,this.isLoaded=!1,this.datasets=[],this.catalogs=[],this.services={},this.parentCatalog=e,this.metadata={},this._catalogJson=a,this._requestor=s,this._urlObj=s.parseUrl(this.url),this._catalogBaseUrl=this.url.replace("catalog.xml",""),this._rootUrl=`${this._urlObj.protocol}//${this._urlObj.host}`}get hasDatasets(){return"dataset"in this._catalogJson}get hasNestedCatalogs(){return"catalogRef"in this._catalogJson}get supportsWms(){return"wms"in this.services}get wmsBase(){return this.supportsWms?`${this._rootUrl}${this.services.wms.baseUrl}`:null}async _loadCatalog(){this._catalogJson=await this._requestor.getData(this.url),this.isLoaded=!0,await this._processCatalog()}async _processCatalog(){const t=this._catalogJson;if(null!==this.name&&""!==this.name||(this.name=t.name),null!==this.title&&""!==this.title||(this.title=t["xlink:title"]),null===this.id&&(this.id=t.ID),0===Object.keys(this.metadata).length&&void 0!==t.metadata&&(this.metadata=t.metadata),t.dataset){Array.isArray(t.dataset)||(t.dataset=[t.dataset]);for(var a=0;a<t.dataset.length;a++){const s=new e(t.dataset[a],this);await s.getNestedDatasets(),this.datasets.push(s)}}if(t.service&&this._getServicesRecursively(t.service),t.catalogRef){Array.isArray(t.catalogRef)||(t.catalogRef=[t.catalogRef]);for(let a=0;a<t.catalogRef.length;a++){const e=this._cleanUrl(t.catalogRef[a]["xlink:href"]);try{const s=new r(e,t.catalogRef[a],this,this._requestor);this.catalogs.push(s)}catch(t){console.error(`\n                        Couldn't create catalog in catalog: ${e}\n                        Parent was: ${this.url}\n                        ${t}`)}}}}async loadAllNestedCatalogs(){for(let t=0;t<this.catalogs.length;t++){const a=this.catalogs[t];try{await a._loadCatalog(),await a.loadAllNestedCatalogs()}catch(t){console.error(`\n                    Couldn't create catalog in catalog: ${a.url}\n                    Parent was: ${this.url}\n                    ${t}`)}}}async loadNestedCatalogById(t){let a=!1;for(let e=0;e<this.catalogs.length;e++){const s=this.catalogs[e];if(s.id===t){a=!0;try{return await s._loadCatalog(),s}catch(t){console.error(`\n                    Couldn't create catalog in catalog: ${s.url}\n                    Parent was: ${this.url}\n                    ${t}`)}}}if(!a)throw new Error(`Could not find catalog using id: ${t}`)}_getServicesRecursively(t){Array.isArray(t)&&(t=t[0]);for(let a=0;a<t.service.length;a++){const e=t.service[a];if("service"in e)this._getServicesRecursively(e);else{const t=new s(e);this.services[t.name]=t}}}_cleanUrl(t){return t.indexOf("://")>=0?t:-1===t.indexOf("thredds")?`${this._catalogBaseUrl}/${t}`:`${this._rootUrl}${t}`}getAllChildDatasets(){let t=[];for(var a=0;a<this.catalogs.length;a++)t=t.concat(this.catalogs[a].getAllChildDatasets());for(let a=0;a<this.datasets.length;a++)if(this.datasets[a].isParentDataset)for(var e=0;e<this.datasets[a].datasets.length;e++)t.push(this.datasets[a].datasets[e]);else t.push(this.datasets[a]);return t}}return async function(e,s){"proxy"in(s=null==s?{}:s)&&(s.proxy="/"===s.proxy.slice(-1)?s.proxy:s.proxy+"/");const l=new t(a,s,DOMParser);return await async function(t,a){const e=new r(t,null,null,a);return await e._loadCatalog(),e}(e,l)}}));
